name: ðŸš€ Deploy - Mathilde Fleurs

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# Permissions nÃ©cessaires
permissions:
  contents: read
  deployments: write
  id-token: write
  pages: write

env:
  NODE_VERSION: '18'

jobs:
  # ðŸ” DÃ©terminer l'environnement
  determine-environment:
    name: ðŸŽ¯ DÃ©terminer Environnement
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      deploy-url: ${{ steps.env.outputs.deploy-url }}
    
    steps:
      - name: ðŸŽ¯ Set Environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi
          
          # URLs selon l'environnement
          if [[ "${{ steps.env.outputs.environment || 'staging' }}" == "production" ]]; then
            echo "deploy-url=https://app.mathilde-fleurs.com" >> $GITHUB_OUTPUT
          else
            echo "deploy-url=https://staging.mathilde-fleurs.com" >> $GITHUB_OUTPUT
          fi

  # ðŸ—ï¸ Build pour dÃ©ploiement
  build-for-deploy:
    name: ðŸ—ï¸ Build DÃ©ploiement
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run Tests
        run: npm run test:coverage

      - name: ðŸ—ï¸ Build Production
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_VAPID_PUBLIC_KEY: ${{ vars.VITE_VAPID_PUBLIC_KEY }}
          VITE_ENVIRONMENT: ${{ needs.determine-environment.outputs.environment }}

      - name: ðŸ“¦ Create Deployment Package
        run: |
          # CrÃ©er un package avec mÃ©tadonnÃ©es
          echo "CrÃ©ation du package de dÃ©ploiement..."
          
          # Ajouter les mÃ©tadonnÃ©es
          cat > dist/deploy-info.json << EOF
          {
            "version": "$(jq -r .version package.json)",
            "environment": "${{ needs.determine-environment.outputs.environment }}",
            "deployTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commitSha": "${{ github.sha }}",
            "commitMessage": $(echo '${{ github.event.head_commit.message }}' | jq -R .),
            "branch": "${{ github.ref_name }}",
            "workflow": "${{ github.run_id }}"
          }
          EOF
          
          # CrÃ©er l'archive
          tar -czf deploy-package.tar.gz -C dist .

      - name: ðŸ“¤ Upload Deployment Package
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package-${{ needs.determine-environment.outputs.environment }}
          path: deploy-package.tar.gz
          retention-days: 90

  # ðŸš€ DÃ©ploiement Staging
  deploy-staging:
    name: ðŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: [determine-environment, build-for-deploy]
    if: needs.determine-environment.outputs.environment == 'staging'
    environment:
      name: staging
      url: ${{ needs.determine-environment.outputs.deploy-url }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Package
        uses: actions/download-artifact@v4
        with:
          name: deploy-package-staging

      - name: ðŸ“¦ Extract Package
        run: |
          mkdir -p staging-deploy
          tar -xzf deploy-package.tar.gz -C staging-deploy

      - name: ðŸš€ Deploy to Staging
        run: |
          echo "ðŸš€ DÃ©ploiement vers Staging..."
          echo "URL: ${{ needs.determine-environment.outputs.deploy-url }}"
          
          # Ici vous ajouteriez vos commandes de dÃ©ploiement rÃ©elles
          # Exemples possibles :
          
          # Pour un dÃ©ploiement sur serveur
          # rsync -avz --delete staging-deploy/ user@staging-server:/var/www/mathilde-fleurs/
          
          # Pour un dÃ©ploiement sur Netlify
          # npx netlify deploy --prod --dir=staging-deploy --site=${{ secrets.NETLIFY_SITE_ID }}
          
          # Pour un dÃ©ploiement sur Vercel
          # npx vercel deploy staging-deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
          
          # Pour GitHub Pages
          # (voir job sÃ©parÃ© ci-dessous)
          
          echo "âœ… DÃ©ploiement staging terminÃ©"

      - name: ðŸ¥ Health Check
        run: |
          echo "ðŸ¥ VÃ©rification de santÃ©..."
          
          # Attendre que le dÃ©ploiement soit effectif
          sleep 30
          
          # VÃ©rifier que le site rÃ©pond
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            if curl -f -s --max-time 10 "${{ needs.determine-environment.outputs.deploy-url }}" > /dev/null; then
              echo "âœ… Site accessible"
              break
            else
              echo "â³ Tentative $attempt/$max_attempts..."
              sleep 10
              ((attempt++))
            fi
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "âŒ Site non accessible aprÃ¨s dÃ©ploiement"
            exit 1
          fi

      - name: ðŸ“Š Post-Deploy Tests
        run: |
          echo "ðŸ§ª Tests post-dÃ©ploiement..."
          
          # Tests de base
          URL="${{ needs.determine-environment.outputs.deploy-url }}"
          
          # VÃ©rifier la page d'accueil
          if ! curl -f -s "$URL" | grep -q "Mathilde Fleurs"; then
            echo "âŒ Page d'accueil incorrecte"
            exit 1
          fi
          
          # VÃ©rifier le manifest PWA
          if ! curl -f -s "$URL/manifest.json" > /dev/null; then
            echo "âš ï¸ Manifest PWA non accessible"
          fi
          
          # VÃ©rifier le service worker
          if ! curl -f -s "$URL/sw.js" > /dev/null; then
            echo "âš ï¸ Service Worker non accessible"
          fi
          
          echo "âœ… Tests post-dÃ©ploiement OK"

  # ðŸš€ DÃ©ploiement Production
  deploy-production:
    name: ðŸš€ Deploy Production
    runs-on: ubuntu-latest
    needs: [determine-environment, build-for-deploy]
    if: needs.determine-environment.outputs.environment == 'production'
    environment:
      name: production
      url: ${{ needs.determine-environment.outputs.deploy-url }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš ï¸ Production Deployment Warning
        run: |
          echo "ðŸš¨ DÃ‰PLOIEMENT EN PRODUCTION ðŸš¨"
          echo "Environnement: Production"
          echo "URL: ${{ needs.determine-environment.outputs.deploy-url }}"
          echo "Version: $(jq -r .version package.json)"
          echo "Commit: ${{ github.sha }}"

      - name: ðŸ“¥ Download Package
        uses: actions/download-artifact@v4
        with:
          name: deploy-package-production

      - name: ðŸ“¦ Extract Package
        run: |
          mkdir -p production-deploy
          tar -xzf deploy-package.tar.gz -C production-deploy

      - name: ðŸ”’ Security Checks
        run: |
          echo "ðŸ”’ VÃ©rifications de sÃ©curitÃ© production..."
          
          # VÃ©rifier qu'il n'y a pas de fichiers sensibles
          if find production-deploy -name "*.env*" -o -name "*.key" -o -name "*.pem"; then
            echo "âŒ Fichiers sensibles dÃ©tectÃ©s"
            exit 1
          fi
          
          # VÃ©rifier la configuration de sÃ©curitÃ©
          if ! grep -q "Content-Security-Policy" production-deploy/index.html; then
            echo "âš ï¸ CSP non configurÃ©"
          fi
          
          echo "âœ… VÃ©rifications de sÃ©curitÃ© OK"

      - name: ðŸ“Š Pre-Deploy Metrics
        id: pre-metrics
        run: |
          echo "ðŸ“Š MÃ©triques prÃ©-dÃ©ploiement..."
          
          # Collecter les mÃ©triques actuelles (si site existant)
          if curl -f -s "${{ needs.determine-environment.outputs.deploy-url }}" > /dev/null; then
            echo "current-site-available=true" >> $GITHUB_OUTPUT
            echo "âœ… Site actuel accessible"
          else
            echo "current-site-available=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Premier dÃ©ploiement"
          fi

      - name: ðŸš€ Deploy to Production
        run: |
          echo "ðŸš€ DÃ©ploiement vers Production..."
          
          # DÃ©ploiement production avec stratÃ©gie blue-green ou rolling
          echo "StratÃ©gie: Blue-Green Deployment"
          
          # Ici vous ajouteriez vos commandes de dÃ©ploiement production
          # avec des vÃ©rifications et rollback automatique
          
          echo "âœ… DÃ©ploiement production terminÃ©"

      - name: ðŸ¥ Comprehensive Health Check
        run: |
          echo "ðŸ¥ VÃ©rification de santÃ© complÃ¨te..."
          
          URL="${{ needs.determine-environment.outputs.deploy-url }}"
          
          # Tests plus complets pour la production
          sleep 60  # Laisser plus de temps pour la propagation
          
          # VÃ©rifier la disponibilitÃ©
          for i in {1..20}; do
            if curl -f -s --max-time 15 "$URL" > /dev/null; then
              echo "âœ… Site disponible (tentative $i)"
              break
            fi
            sleep 15
          done
          
          # Tests fonctionnels de base
          echo "ðŸ§ª Tests fonctionnels..."
          
          # Page d'accueil
          if ! curl -f -s "$URL" | grep -q "Mathilde Fleurs"; then
            echo "âŒ Page d'accueil problÃ©matique"
            exit 1
          fi
          
          # API Health check (si disponible)
          if curl -f -s "$URL/api/health" > /dev/null; then
            echo "âœ… API Health check OK"
          fi
          
          echo "âœ… Health check production OK"

      - name: ðŸ“ˆ Post-Deploy Monitoring
        run: |
          echo "ðŸ“ˆ Activation du monitoring renforcÃ©..."
          
          # Ici vous pourriez :
          # - Activer des alertes spÃ©ciales
          # - Programmer des vÃ©rifications automatiques
          # - Envoyer des notifications aux Ã©quipes
          
          echo "âœ… Monitoring activÃ©"

  # ðŸ“„ DÃ©ploiement GitHub Pages (pour demo/docs)
  deploy-github-pages:
    name: ðŸ“„ Deploy GitHub Pages
    runs-on: ubuntu-latest
    needs: [determine-environment, build-for-deploy]
    if: needs.determine-environment.outputs.environment == 'staging'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ðŸ“¥ Download Package
        uses: actions/download-artifact@v4
        with:
          name: deploy-package-staging

      - name: ðŸ“¦ Extract for Pages
        run: |
          mkdir -p pages-deploy
          tar -xzf deploy-package.tar.gz -C pages-deploy

      - name: ðŸ“„ Setup Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“¤ Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages-deploy

      - name: ðŸš€ Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ðŸ“¢ Notifications
  notify:
    name: ðŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result != 'skipped' || needs.deploy-production.result != 'skipped')
    
    steps:
      - name: ðŸ“¢ Deploy Success Notification
        if: >
          (needs.deploy-staging.result == 'success' && needs.determine-environment.outputs.environment == 'staging') ||
          (needs.deploy-production.result == 'success' && needs.determine-environment.outputs.environment == 'production')
        run: |
          echo "ðŸŽ‰ DÃ©ploiement rÃ©ussi !"
          echo "Environnement: ${{ needs.determine-environment.outputs.environment }}"
          echo "URL: ${{ needs.determine-environment.outputs.deploy-url }}"
          
          # Ici vous pourriez envoyer des notifications :
          # - Slack/Discord webhook
          # - Email
          # - SMS
          # - Teams

      - name: ðŸ“¢ Deploy Failure Notification
        if: >
          (needs.deploy-staging.result == 'failure' && needs.determine-environment.outputs.environment == 'staging') ||
          (needs.deploy-production.result == 'failure' && needs.determine-environment.outputs.environment == 'production')
        run: |
          echo "âŒ DÃ©ploiement Ã©chouÃ© !"
          echo "Environnement: ${{ needs.determine-environment.outputs.environment }}"
          
          # Notifications d'urgence pour les Ã©checs

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ RÃ©sumÃ© du DÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ParamÃ¨tre | Valeur |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environnement** | ${{ needs.determine-environment.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ needs.determine-environment.outputs.deploy-url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | $(jq -r .version package.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Trigger** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy-staging.result }}" == "success" || "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "âœ… **DÃ©ploiement rÃ©ussi !**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **DÃ©ploiement Ã©chouÃ©.**" >> $GITHUB_STEP_SUMMARY
          fi
