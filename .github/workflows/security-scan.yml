name: ðŸ”’ Security Scan - Mathilde Fleurs

on:
  schedule:
    # Scan quotidien Ã  2h du matin UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main, develop ]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'src/**'
      - '.github/workflows/security-scan.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Permissions minimales
permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '18'

jobs:
  # ðŸ” Audit des dÃ©pendances
  dependency-audit:
    name: ðŸ” Audit DÃ©pendances
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci --audit

      - name: ðŸ”’ NPM Audit
        run: |
          echo "ðŸ” Audit NPM des vulnÃ©rabilitÃ©s..."
          npm audit --audit-level moderate
          
          # GÃ©nÃ©rer un rapport dÃ©taillÃ©
          npm audit --json > npm-audit-report.json
          
          # VÃ©rifier les vulnÃ©rabilitÃ©s critiques et hautes
          CRITICAL=$(npm audit --json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(npm audit --json | jq '.metadata.vulnerabilities.high // 0')
          
          echo "VulnÃ©rabilitÃ©s critiques: $CRITICAL"
          echo "VulnÃ©rabilitÃ©s hautes: $HIGH"
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âŒ VulnÃ©rabilitÃ©s critiques ou hautes dÃ©tectÃ©es"
            echo "ðŸ“Š DÃ©tails dans npm-audit-report.json"
            exit 1
          fi
          
          echo "âœ… Aucune vulnÃ©rabilitÃ© critique ou haute"

      - name: ðŸ“¤ Upload Audit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 30

  # ðŸ”’ Scan des secrets
  secret-scan:
    name: ðŸ”’ Scan Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” GitLeaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: ðŸ” TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # ðŸ›¡ï¸ Analyse statique du code
  static-analysis:
    name: ðŸ›¡ï¸ Analyse Statique
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” ESLint Security Rules
        run: |
          echo "ðŸ” VÃ©rification des rÃ¨gles de sÃ©curitÃ© ESLint..."
          
          # CrÃ©er une config ESLint pour la sÃ©curitÃ©
          cat > .eslintrc.security.json << EOF
          {
            "extends": [".eslintrc.json"],
            "plugins": ["security"],
            "rules": {
              "security/detect-object-injection": "error",
              "security/detect-non-literal-regexp": "error",
              "security/detect-non-literal-fs-filename": "error",
              "security/detect-eval-with-expression": "error",
              "security/detect-pseudoRandomBytes": "error",
              "security/detect-possible-timing-attacks": "error"
            }
          }
          EOF
          
          npx eslint . --ext .js,.jsx,.ts,.tsx \
            --config .eslintrc.security.json \
            --format json \
            --output-file eslint-security-report.json || true
          
          # Analyser les rÃ©sultats
          if [ -f eslint-security-report.json ]; then
            SECURITY_ERRORS=$(cat eslint-security-report.json | jq '[.[] | .messages[] | select(.ruleId | contains("security/"))] | length')
            
            if [ "$SECURITY_ERRORS" -gt 0 ]; then
              echo "âš ï¸ $SECURITY_ERRORS erreurs de sÃ©curitÃ© dÃ©tectÃ©es"
              cat eslint-security-report.json | jq '.[] | .messages[] | select(.ruleId | contains("security/"))'
            else
              echo "âœ… Aucune erreur de sÃ©curitÃ© ESLint"
            fi
          fi

      - name: ðŸ” Semgrep SAST
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/react
            p/typescript
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: ðŸ“¤ Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-reports
          path: |
            eslint-security-report.json
          retention-days: 30

  # ðŸ”’ Scan Trivy
  trivy-scan:
    name: ðŸ”’ Scan Trivy
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ðŸ“¤ Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ðŸ“¤ Upload Trivy Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-results.sarif
          retention-days: 30

  # ðŸ•·ï¸ OWASP ZAP Scan
  zap-scan:
    name: ðŸ•·ï¸ OWASP ZAP Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install and Build
        run: |
          npm ci
          npm run build

      - name: ðŸš€ Start Application
        run: |
          npm run preview &
          sleep 30
        env:
          CI: true

      - name: ðŸ•·ï¸ ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://localhost:4173'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: false

      - name: ðŸ•·ï¸ ZAP Full Scan
        if: github.event_name == 'workflow_dispatch'
        uses: zaproxy/action-full-scan@v0.4.0
        with:
          target: 'http://localhost:4173'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: false

      - name: ðŸ“¤ Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: report_html.html
          retention-days: 30

  # ðŸ” Configuration de sÃ©curitÃ©
  security-config-check:
    name: ðŸ” VÃ©rif Config SÃ©curitÃ©
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Security Headers Check
        run: |
          echo "ðŸ” VÃ©rification des headers de sÃ©curitÃ©..."
          
          # VÃ©rifier la prÃ©sence des headers de sÃ©curitÃ© dans index.html
          SECURITY_HEADERS=(
            "Content-Security-Policy"
            "X-Frame-Options"
            "X-Content-Type-Options"
            "X-XSS-Protection"
            "Referrer-Policy"
          )
          
          MISSING_HEADERS=()
          
          for header in "${SECURITY_HEADERS[@]}"; do
            if ! grep -q "$header" index.html; then
              MISSING_HEADERS+=("$header")
            fi
          done
          
          if [ ${#MISSING_HEADERS[@]} -eq 0 ]; then
            echo "âœ… Tous les headers de sÃ©curitÃ© sont prÃ©sents"
          else
            echo "âš ï¸ Headers manquants:"
            printf '%s\n' "${MISSING_HEADERS[@]}"
          fi

      - name: ðŸ” Environment Variables Check
        run: |
          echo "ðŸ” VÃ©rification des variables d'environnement..."
          
          # VÃ©rifier qu'il n'y a pas de secrets hardcodÃ©s
          if find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | xargs grep -E "(password|secret|key|token)\s*=\s*['\"][^'\"]+['\"]" --color=never; then
            echo "âŒ Secrets potentiels dÃ©tectÃ©s dans le code"
            exit 1
          else
            echo "âœ… Aucun secret hardcodÃ© dÃ©tectÃ©"
          fi

      - name: ðŸ” HTTPS Configuration Check
        run: |
          echo "ðŸ” VÃ©rification de la configuration HTTPS..."
          
          # VÃ©rifier la configuration PWA pour HTTPS
          if grep -q '"start_url": "https://' public/manifest.json; then
            echo "âœ… HTTPS configurÃ© dans le manifest"
          else
            echo "âš ï¸ HTTPS non configurÃ© dans le manifest"
          fi

  # ðŸ“Š Rapport de sÃ©curitÃ© consolidÃ©
  security-summary:
    name: ðŸ“Š RÃ©sumÃ© SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scan, static-analysis, trivy-scan, security-config-check]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Security Summary
        run: |
          echo "## ðŸ”’ RÃ©sumÃ© de SÃ©curitÃ© - Mathilde Fleurs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status | DÃ©tails |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Audit DÃ©pendances | ${{ needs.dependency-audit.result == 'success' && 'âœ… RÃ©ussi' || 'âŒ Ã‰chouÃ©' }} | VulnÃ©rabilitÃ©s NPM |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Scan Secrets | ${{ needs.secret-scan.result == 'success' && 'âœ… RÃ©ussi' || 'âŒ Ã‰chouÃ©' }} | GitLeaks + TruffleHog |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Analyse Statique | ${{ needs.static-analysis.result == 'success' && 'âœ… RÃ©ussi' || 'âŒ Ã‰chouÃ©' }} | ESLint + Semgrep |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Scan Trivy | ${{ needs.trivy-scan.result == 'success' && 'âœ… RÃ©ussi' || 'âŒ Ã‰chouÃ©' }} | VulnÃ©rabilitÃ©s OS/libs |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Config SÃ©curitÃ© | ${{ needs.security-config-check.result == 'success' && 'âœ… RÃ©ussi' || 'âŒ Ã‰chouÃ©' }} | Headers & Config |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Compter les succÃ¨s
          SUCCESSFUL_SCANS=0
          TOTAL_SCANS=5
          
          [[ "${{ needs.dependency-audit.result }}" == "success" ]] && ((SUCCESSFUL_SCANS++))
          [[ "${{ needs.secret-scan.result }}" == "success" ]] && ((SUCCESSFUL_SCANS++))
          [[ "${{ needs.static-analysis.result }}" == "success" ]] && ((SUCCESSFUL_SCANS++))
          [[ "${{ needs.trivy-scan.result }}" == "success" ]] && ((SUCCESSFUL_SCANS++))
          [[ "${{ needs.security-config-check.result }}" == "success" ]] && ((SUCCESSFUL_SCANS++))
          
          echo "**Score de sÃ©curitÃ©: $SUCCESSFUL_SCANS/$TOTAL_SCANS**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $SUCCESSFUL_SCANS -eq $TOTAL_SCANS ]; then
            echo "ðŸŽ‰ **Tous les contrÃ´les de sÃ©curitÃ© sont passÃ©s !**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Certains contrÃ´les de sÃ©curitÃ© ont Ã©chouÃ©. Action requise.**" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Recommandations
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Recommandations:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.dependency-audit.result }}" != "success" ]]; then
            echo "- ðŸ” **DÃ©pendances**: Mettre Ã  jour les packages vulnÃ©rables avec \`npm audit fix\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.secret-scan.result }}" != "success" ]]; then
            echo "- ðŸ”’ **Secrets**: Supprimer les secrets du code et utiliser des variables d'environnement" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.static-analysis.result }}" != "success" ]]; then
            echo "- ðŸ›¡ï¸ **Code**: Corriger les problÃ¨mes de sÃ©curitÃ© identifiÃ©s par l'analyse statique" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.trivy-scan.result }}" != "success" ]]; then
            echo "- ðŸ”’ **VulnÃ©rabilitÃ©s**: Examiner et corriger les vulnÃ©rabilitÃ©s dÃ©tectÃ©es par Trivy" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.security-config-check.result }}" != "success" ]]; then
            echo "- ðŸ” **Configuration**: AmÃ©liorer la configuration de sÃ©curitÃ© (headers, HTTPS)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“§ Security Alert
        if: >
          needs.dependency-audit.result == 'failure' ||
          needs.secret-scan.result == 'failure' ||
          needs.static-analysis.result == 'failure' ||
          needs.trivy-scan.result == 'failure'
        run: |
          echo "ðŸš¨ ALERTE SÃ‰CURITÃ‰ ðŸš¨"
          echo "Des problÃ¨mes de sÃ©curitÃ© critiques ont Ã©tÃ© dÃ©tectÃ©s."
          echo "Action immÃ©diate requise avant le dÃ©ploiement."
          
          # Ici vous pourriez envoyer des notifications d'urgence
          
          exit 1

  # ðŸ”’ Recommandations de sÃ©curitÃ©
  security-recommendations:
    name: ðŸ”’ Recommandations
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”’ Generate Security Recommendations
        run: |
          echo "ðŸ”’ GÃ©nÃ©ration des recommandations de sÃ©curitÃ©..."
          
          # Analyser les dÃ©pendances obsolÃ¨tes
          npx npm-check-updates --format json > ncu-report.json || true
          
          # GÃ©nÃ©rer un rapport de recommandations
          cat > security-recommendations.md << EOF
          # ðŸ”’ Recommandations de SÃ©curitÃ© - Mathilde Fleurs
          
          ## ðŸ“Š Statut Actuel
          - Date d'analyse: $(date)
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}
          
          ## ðŸ”„ Mises Ã  Jour RecommandÃ©es
          \`\`\`bash
          # Mettre Ã  jour les dÃ©pendances
          npm update
          
          # VÃ©rifier les vulnÃ©rabilitÃ©s
          npm audit
          
          # Corriger automatiquement
          npm audit fix
          \`\`\`
          
          ## ðŸ›¡ï¸ Bonnes Pratiques
          - [ ] Mettre Ã  jour rÃ©guliÃ¨rement les dÃ©pendances
          - [ ] Utiliser des variables d'environnement pour les secrets
          - [ ] ImplÃ©menter une CSP stricte
          - [ ] Activer HTTPS en production
          - [ ] Surveiller les vulnÃ©rabilitÃ©s en continu
          
          ## ðŸ” Prochaines Actions
          1. Examiner les vulnÃ©rabilitÃ©s dÃ©tectÃ©es
          2. Planifier les mises Ã  jour de sÃ©curitÃ©
          3. Tester les correctifs en staging
          4. DÃ©ployer les correctifs en production
          EOF
          
          echo "âœ… Recommandations gÃ©nÃ©rÃ©es"

      - name: ðŸ“¤ Upload Recommendations
        uses: actions/upload-artifact@v4
        with:
          name: security-recommendations
          path: security-recommendations.md
          retention-days: 90
